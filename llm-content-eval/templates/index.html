{% extends "base.html" %}

{% block title %}Dashboard - LLM Content Evaluation{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Experiments Dashboard</h1>
    
    <div class="mb-6 flex justify-between items-center">
        <div>
            <p class="text-gray-600">Manage and track your LLM content generation experiments</p>
        </div>
        <a href="/setup" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
            Create New Experiment
        </a>
    </div>

    <div class="bg-white rounded-lg shadow overflow-hidden">
        <table class="min-w-full">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Name
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Created
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Progress
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody id="experiments-table" class="bg-white divide-y divide-gray-200">
                <!-- Experiments will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<script>
async function loadExperiments() {
    try {
        const response = await fetch('/api/experiments');
        const experiments = await response.json();
        
        const tbody = document.getElementById('experiments-table');
        tbody.innerHTML = '';
        
        if (experiments.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                        No experiments yet. <a href="/setup" class="text-blue-600 hover:underline">Create your first experiment</a>
                    </td>
                </tr>
            `;
            return;
        }
        
        experiments.forEach(exp => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${exp.name}</div>
                    <div class="text-sm text-gray-500">${exp.description || 'No description'}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                        ${getStatusColor(exp.status)}">
                        ${exp.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${new Date(exp.created_at).toLocaleDateString()}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900" id="progress-${exp.id}">
                        Loading...
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    ${getActionButtons(exp)}
                </td>
            `;
            tbody.appendChild(row);
            
            // Load progress
            loadProgress(exp.id);
        });
    } catch (error) {
        console.error('Error loading experiments:', error);
    }
}

function getStatusColor(status) {
    const colors = {
        'setup': 'bg-gray-100 text-gray-800',
        'generating': 'bg-yellow-100 text-yellow-800',
        'evaluating': 'bg-blue-100 text-blue-800',
        'complete': 'bg-green-100 text-green-800'
    };
    return colors[status] || 'bg-gray-100 text-gray-800';
}

function getActionButtons(exp) {
    let buttons = '';
    
    if (exp.status === 'setup') {
        buttons += `<a href="/generate/${exp.id}" class="text-indigo-600 hover:text-indigo-900 mr-3">Generate</a>`;
    } else if (exp.status === 'generating') {
        buttons += `<a href="/generate/${exp.id}" class="text-indigo-600 hover:text-indigo-900 mr-3">View Progress</a>`;
    } else if (exp.status === 'evaluating') {
        buttons += `<a href="/evaluate/${exp.id}" class="text-indigo-600 hover:text-indigo-900 mr-3">Evaluate</a>`;
    } else if (exp.status === 'complete') {
        buttons += `<a href="/results/${exp.id}" class="text-indigo-600 hover:text-indigo-900 mr-3">View Results</a>`;
    }
    
    buttons += `<button onclick="deleteExperiment(${exp.id})" class="text-red-600 hover:text-red-900">Delete</button>`;
    
    return buttons;
}

async function loadProgress(experimentId) {
    try {
        const [genResponse, evalResponse] = await Promise.all([
            fetch(`/api/generations/progress/${experimentId}`),
            fetch(`/api/evaluations/progress/${experimentId}`)
        ]);
        
        const genProgress = await genResponse.json();
        const evalProgress = await evalResponse.json();
        
        const progressDiv = document.getElementById(`progress-${experimentId}`);
        progressDiv.innerHTML = `
            Gen: ${genProgress.completed}/${genProgress.total} | 
            Eval: ${evalProgress.completed}/${evalProgress.total}
        `;
    } catch (error) {
        console.error('Error loading progress:', error);
    }
}

async function deleteExperiment(id) {
    if (!confirm('Are you sure you want to delete this experiment?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/experiments/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadExperiments();
        }
    } catch (error) {
        console.error('Error deleting experiment:', error);
    }
}

// Load experiments on page load
document.addEventListener('DOMContentLoaded', loadExperiments);

// Refresh every 5 seconds
setInterval(loadExperiments, 5000);
</script>
{% endblock %}