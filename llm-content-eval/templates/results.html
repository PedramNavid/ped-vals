{% extends "base.html" %}

{% block title %}Results - LLM Content Evaluation{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto">
    <h1 class="text-3xl font-bold text-gray-900 mb-8">Experiment Results</h1>
    
    <!-- Summary Stats -->
    <div class="grid grid-cols-4 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-medium text-gray-500">Total Generations</h3>
            <p class="text-2xl font-bold text-gray-900" id="total-generations">--</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-medium text-gray-500">Total Evaluations</h3>
            <p class="text-2xl font-bold text-gray-900" id="total-evaluations">--</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-medium text-gray-500">Total Cost</h3>
            <p class="text-2xl font-bold text-gray-900" id="total-cost">--</p>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-sm font-medium text-gray-500">Avg Quality Score</h3>
            <p class="text-2xl font-bold text-gray-900" id="avg-quality">--</p>
        </div>
    </div>
    
    <!-- Best/Worst Combinations -->
    <div class="grid grid-cols-2 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-3">Best Combination</h3>
            <div id="best-combination" class="text-sm">
                Loading...
            </div>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-3">Worst Combination</h3>
            <div id="worst-combination" class="text-sm">
                Loading...
            </div>
        </div>
    </div>
    
    <!-- Charts -->
    <div class="grid grid-cols-2 gap-4 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-3">Performance by Model</h3>
            <canvas id="model-chart"></canvas>
        </div>
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold mb-3">Performance by Strategy</h3>
            <canvas id="strategy-chart"></canvas>
        </div>
    </div>
    
    <!-- Heatmap -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <h3 class="text-lg font-semibold mb-3">Model vs Strategy Heatmap</h3>
        <div id="heatmap-container"></div>
    </div>
    
    <!-- Detailed Tables -->
    <div class="bg-white rounded-lg shadow p-6 mb-8">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold">Detailed Results by Model</h3>
            <button onclick="exportCSV()" class="text-blue-600 hover:text-blue-800 text-sm">
                Export to CSV
            </button>
        </div>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Model</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Voice Match</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Coherence</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Engaging</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Meets Brief</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Overall</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Would Publish</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg Cost</th>
                    </tr>
                </thead>
                <tbody id="model-results-table" class="bg-white divide-y divide-gray-200">
                    <!-- Results will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Task Analysis -->
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-semibold mb-4">Results by Task</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Task</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg Score</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Best Model</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Best Strategy</th>
                    </tr>
                </thead>
                <tbody id="task-results-table" class="bg-white divide-y divide-gray-200">
                    <!-- Results will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
const experimentId = {{ experiment_id }};

async function loadSummary() {
    try {
        const response = await fetch(`/api/analysis/${experimentId}/summary`);
        const summary = await response.json();
        
        // Update summary stats
        document.getElementById('total-generations').textContent = summary.total_generations;
        document.getElementById('total-evaluations').textContent = summary.total_evaluations;
        document.getElementById('total-cost').textContent = `$${summary.total_cost.toFixed(4)}`;
        document.getElementById('avg-quality').textContent = summary.avg_scores.overall_quality.toFixed(2);
        
        // Update best/worst
        const bestDiv = document.getElementById('best-combination');
        if (summary.best_combination.model_provider) {
            bestDiv.innerHTML = `
                <p><strong>Model:</strong> ${summary.best_combination.model_provider}/${summary.best_combination.model_name}</p>
                <p><strong>Strategy:</strong> ${summary.best_combination.prompt_strategy}</p>
                <p><strong>Task:</strong> ${summary.best_combination.task_id}</p>
                <p><strong>Score:</strong> ${summary.best_combination.overall_quality}/5</p>
            `;
        }
        
        const worstDiv = document.getElementById('worst-combination');
        if (summary.worst_combination.model_provider) {
            worstDiv.innerHTML = `
                <p><strong>Model:</strong> ${summary.worst_combination.model_provider}/${summary.worst_combination.model_name}</p>
                <p><strong>Strategy:</strong> ${summary.worst_combination.prompt_strategy}</p>
                <p><strong>Task:</strong> ${summary.worst_combination.task_id}</p>
                <p><strong>Score:</strong> ${summary.worst_combination.overall_quality}/5</p>
            `;
        }
    } catch (error) {
        console.error('Error loading summary:', error);
    }
}

async function loadModelAnalysis() {
    try {
        const response = await fetch(`/api/analysis/${experimentId}/by-model`);
        const models = await response.json();
        
        // Update table
        const tbody = document.getElementById('model-results-table');
        tbody.innerHTML = '';
        
        models.forEach(model => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${model.model_provider}/${model.model_name}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${model.avg_scores.voice_match.toFixed(2)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${model.avg_scores.coherence.toFixed(2)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${model.avg_scores.engaging.toFixed(2)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${model.avg_scores.meets_brief.toFixed(2)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${model.avg_scores.overall_quality.toFixed(2)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${(model.would_publish_rate * 100).toFixed(0)}%
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    $${model.avg_cost.toFixed(4)}
                </td>
            `;
            tbody.appendChild(row);
        });
        
        // Create chart
        const ctx = document.getElementById('model-chart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: models.map(m => `${m.model_provider}/${m.model_name}`),
                datasets: [{
                    label: 'Overall Quality',
                    data: models.map(m => m.avg_scores.overall_quality),
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 1
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 5
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading model analysis:', error);
    }
}

async function loadStrategyAnalysis() {
    try {
        const response = await fetch(`/api/analysis/${experimentId}/by-strategy`);
        const strategies = await response.json();
        
        // Create chart
        const ctx = document.getElementById('strategy-chart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['Voice Match', 'Coherence', 'Engaging', 'Meets Brief', 'Overall'],
                datasets: strategies.map((s, i) => ({
                    label: s.strategy,
                    data: [
                        s.avg_scores.voice_match,
                        s.avg_scores.coherence,
                        s.avg_scores.engaging,
                        s.avg_scores.meets_brief,
                        s.avg_scores.overall_quality
                    ],
                    borderColor: i === 0 ? 'rgb(59, 130, 246)' : 'rgb(16, 185, 129)',
                    backgroundColor: i === 0 ? 'rgba(59, 130, 246, 0.2)' : 'rgba(16, 185, 129, 0.2)'
                }))
            },
            options: {
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 5
                    }
                }
            }
        });
    } catch (error) {
        console.error('Error loading strategy analysis:', error);
    }
}

async function loadTaskAnalysis() {
    try {
        const response = await fetch(`/api/analysis/${experimentId}/by-task`);
        const tasks = await response.json();
        
        // Update table
        const tbody = document.getElementById('task-results-table');
        tbody.innerHTML = '';
        
        tasks.forEach(task => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    ${task.task_id}: ${task.task_title}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${task.content_type}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${task.avg_scores.overall_quality.toFixed(2)}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${task.best_model}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    ${task.best_strategy}
                </td>
            `;
            tbody.appendChild(row);
        });
    } catch (error) {
        console.error('Error loading task analysis:', error);
    }
}

async function loadHeatmap() {
    try {
        const response = await fetch(`/api/analysis/${experimentId}/heatmap`);
        const data = await response.json();
        
        // Create simple heatmap table
        const container = document.getElementById('heatmap-container');
        let html = '<table class="min-w-full border">';
        html += '<thead><tr><th class="border p-2"></th>';
        
        // Get strategies
        const strategies = ['structured', 'example_based'];
        strategies.forEach(s => {
            html += `<th class="border p-2 text-sm">${s}</th>`;
        });
        html += '</tr></thead><tbody>';
        
        // Add rows for each model
        Object.entries(data).forEach(([model, scores]) => {
            html += `<tr><td class="border p-2 text-sm font-medium">${model}</td>`;
            strategies.forEach(strategy => {
                const score = scores[strategy] || 0;
                const color = getHeatmapColor(score);
                html += `<td class="border p-2 text-center" style="background-color: ${color}">${score}</td>`;
            });
            html += '</tr>';
        });
        
        html += '</tbody></table>';
        container.innerHTML = html;
    } catch (error) {
        console.error('Error loading heatmap:', error);
    }
}

function getHeatmapColor(value) {
    // Scale from red (1) to green (5)
    const percent = (value - 1) / 4;
    const r = Math.floor(255 * (1 - percent));
    const g = Math.floor(255 * percent);
    return `rgba(${r}, ${g}, 0, 0.3)`;
}

async function exportCSV() {
    window.location.href = `/api/analysis/${experimentId}/export`;
}

// Load all data on page load
document.addEventListener('DOMContentLoaded', () => {
    loadSummary();
    loadModelAnalysis();
    loadStrategyAnalysis();
    loadTaskAnalysis();
    loadHeatmap();
});
</script>
{% endblock %}